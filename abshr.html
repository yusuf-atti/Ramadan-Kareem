<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø£Ø¨Ø´Ø± â€“ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</title>

    <style>
        body {
            font-family: "Tahoma";
            background: #f4f7fa;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 60%;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.12);
        }

        h2 {
            text-align: center;
            color: #0a4a92;
        }

        label {
            margin-top: 12px;
            display: block;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border: 1px solid #bbb;
            border-radius: 6px;
        }

        .upload-box {
            padding: 15px;
            background: #eaf2ff;
            border: 2px dashed #0a62d0;
            text-align: center;
            margin-top: 10px;
            border-radius: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #0a4a92;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            cursor: pointer;
            margin-top: 25px;
        }

        #connection-status {
            text-align: center;
            font-weight: bold;
            color: green;
        }

        #alert-box {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ffca2c;
            color: #8a6d3b;
            display: none;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="container">

    <h2>Ø£Ø¨Ø´Ø± â€“ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</h2>

    <div id="connection-status">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    <div id="alert-box">âš ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ â€” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>

    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
    <input type="text" id="idNumber">

    <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
    <select id="serviceType">
        <option>ØªØ¬Ø¯ÙŠØ¯ Ø¬ÙˆØ§Ø²</option>
        <option>Ø¥ØµØ¯Ø§Ø± Ø¥Ù‚Ø§Ù…Ø©</option>
        <option>Ù†Ù‚Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
        <option>ØªØ¬Ø¯ÙŠØ¯ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø©</option>
        <option>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ</option>
        <option>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</option>
        <option>Ø¨Ù„Ø§ØºØ§Øª</option>
        <option>Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
    </select>

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
    <textarea id="notes" rows="4"></textarea>

    <label>ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</label>
    <div class="upload-box">
        <input type="file" id="idImage" accept="image/*">
    </div>

    <button onclick="submitForm()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

</div>

<script>
/* ============================================
   ğŸŸ© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB
============================================ */

let db;
const request = indexedDB.open("AbsherOfflineDB", 1);

request.onupgradeneeded = (event) => {
    db = event.target.result;
    db.createObjectStore("draft", { keyPath: "id" });
};

request.onsuccess = (event) => {
    db = event.target.result;
    console.log("IndexedDB Ø¬Ø§Ù‡Ø²");
    loadDraft();
};

request.onerror = () => console.log("Ø®Ø·Ø£ ÙÙŠ IndexedDB");

/* ============================================
   ğŸŸ© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
============================================ */

function saveDraft() {
    const tx = db.transaction("draft", "readwrite");
    const store = tx.objectStore("draft");

    const fileInput = document.getElementById("idImage").files[0];

    if (fileInput) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const draft = {
                id: 1,
                idNumber: idNumber.value,
                serviceType: serviceType.value,
                notes: notes.value,
                image: e.target.result
            };
            store.put(draft);
        };
        reader.readAsDataURL(fileInput);
    } else {
        const draft = {
            id: 1,
            idNumber: idNumber.value,
            serviceType: serviceType.value,
            notes: notes.value,
            image: null
        };
        store.put(draft);
    }
}

/* Ø­ÙØ¸ Ø¹Ù†Ø¯ ÙƒÙ„ ØªØºÙŠÙŠØ± */
document.querySelectorAll("input, select, textarea")
    .forEach(el => el.addEventListener("input", saveDraft));

/* ============================================
   ğŸŸ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
============================================ */

function loadDraft() {
    const tx = db.transaction("draft", "readonly");
    const store = tx.objectStore("draft");

    const req = store.get(1);

    req.onsuccess = (e) => {
        const data = e.target.result;
        if (!data) return;

        idNumber.value = data.idNumber || "";
        serviceType.value = data.serviceType || "";
        notes.value = data.notes || "";

        if (data.image) {
            console.log("âœ” ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ø­Ù…Ù‘Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ÙˆØ¯Ø©");
        }
    };
}

/* ============================================
   ğŸŸ© ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ (ØªÙ†Ø¨Ø¤ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹)
============================================ */

let fails = 0;

async function checkConnection() {
    try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 2000);

        await fetch("https://jsonplaceholder.typicode.com/todos/1", {
            signal: controller.signal
        });

        document.getElementById("connection-status").innerHTML = "âœ” Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…Ù…ØªØ§Ø²";
        document.getElementById("connection-status").style.color = "green";
        document.getElementById("alert-box").style.display = "none";
        fails = 0;

    } catch {
        fails++;
        document.getElementById("connection-status").innerHTML = "âŒ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„...";
        document.getElementById("connection-status").style.color = "red";

        if (fails >= 2) {
            document.getElementById("alert-box").style.display = "block";
            saveDraft();
        }
    }
}

checkConnection();
setInterval(checkConnection, 5000);

/* ============================================
   ğŸŸ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
============================================ */

function submitForm() {
    if (document.getElementById("alert-box").style.display === "block") {
        alert("âš ï¸ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±ÙÙˆØ¶ Ø¨Ø³Ø¨Ø¨ Ø¶Ø¹Ù Ø§Ù„Ø§ØªØµØ§Ù„.\nØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§.");
        return;
    }

    alert("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ (Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙ‚Ø·)");
}
</script>

</body>
</html>
